---
Title: ' 解放されない リフレクションクラス 2'
Category:
- Tapestry
Date: 2005-11-02T09:13:48+09:00
URL: http://tkatochin.hatenablog.com/entry/20051102/1130890428
EditURL: https://blog.hatena.ne.jp/t-katochin/tkatochin.hatenablog.com/atom/entry/6653586347154756222
---


　どんぴしゃ！犯人確保できました。ognl.OgnlRuntimeが、リフレクションメソッドをクラスごとに永久にキャッシュしているのが問題でした。OGNLは「クラスはアンロードされるもの」という前提では設計されていないのです。
　ちょっと待てよ、ということは…TapestryはOGNLとの組み合わせが前提であるにも関わらず<big>TapestryとOGNLは相性がよくない</big> ということになります。ハワードさんは気づいているのかな。コミュニケーションとりたいけど英語できない。
　使用方法を限定することでパーマネント領域への圧迫はさけられるのですが、それは<big>JVMを落とさずに、.htmlや.pageを修正して、リセットサービスをかけてはならない。</big>ということになります。デザインと実装の分離をしたにも関わらず、コンテンツの入れ替えがサーバー止めないとできないというのは、少なくとも私の抱えている案件では致命的です。
　結局、OgnlRuntimeクラスにパッチをあてて対処することにしました。独自のHashTableもどきで作られているClassCacheという内部クラスを、WeakHashMapを使うように修正しました。キーとなっていたClassが消滅すれば自動的にEntryも消えるという算段です。ローカルでのストレスツールを掛けたテストでは効果があったようです。今日、本番機にアップすることになります。<del datetime="2010-09-17T11:26:25+09:00">今後のためにここからダウンロードできるようにしておきます。</del>((あらら、どこかいっちゃった。URLも消えててもう分からないや))
